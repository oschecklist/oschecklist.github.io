<html>
<head>
    <link rel="stylesheet" href="css/pure-min-0.6.0.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/style.css">

    <script>
        if (!String.prototype.format) {
            String.prototype.format = function() {
                var args = arguments;
                return this.replace(/{(\d+)}/g, function(match, number) {
                    return typeof args[number] != 'undefined' ? args[number] : match ;
                });
            };
        }

        var Tasks = [
            ["icon.png", "Do this."],
            ["icon.png", "Question?", [
                ["icon.png", "Do a thing."],
                ["icon.png", "Do another thing."],
                ["icon.png", "Another question?", [
                    ["icon.png", "More question! Not really."]
                ]]
            ]],
            ["icon.png", "Final thing!"]
        ];

        var Save = {
            version: 0,
            current: [0],
            skipped: [],
            qskipped: []
        };

        function load() {
            var loaded = localStorage.getItem("oschecklist");

            if (loaded != null) {
                Save = JSON.parse(loaded);
            }
        }

        function save() {
            var saveable = JSON.stringify(Save);
            localStorage.setItem("oschecklist", saveable);
        }

        function getTask() {
            /*
            if (Save.current.length < 1) {
                return ["icon.png", "All tasks complete!"];
            }
            */
            var task = Tasks[Save.current[0]]; //no preceding 2
            if (task === undefined) {
                return ["icon.png", "All tasks complete!"];
            }
            for (var i = 1; i < Save.current.length; i++) {
                task = task[2][Save.current[i]];
            }
            return task;
        }

        function getNextTask() {
            console.log(Save);
            /*
            if (Save.current.length < 1) {
                return ["icon.png", "All tasks complete!"];
            }
            */
            Save.current[Save.current.length - 1]++;
            var task = Tasks[Save.current[0]]; //no preceding 2
            if (task === undefined) {
                return ["icon.png", "All tasks complete!"];
            }
            for (var i = 1; i < Save.current.length; i++) {
                if (task[2][Save.current[i]] !== undefined) {
                    task = task[2][Save.current[i]];
                    console.log("THING" + task);
                    console.log("if previous log is undefined / null, check getNextTask()");
                } else {
                    Save.current.pop();
                    return getNextTask();
                }
            }
            return task;
        }

        function display(task) {
            console.log(task);
            if (task.length == 2) {
                document.getElementById("current").innerHTML = "<td style='width:10%;'><button class='pure-button button-complete' onclick='javascript:completeTask();' title='Task complete.'><span class='fa fa-check-circle-o'></span></button></td><td class='task'><img src='{0}'><p>{1}</p></td><td style='width:10%;'><button class='pure-button button-later' onclick='javascript:skipTask();' title='Do this later.'><span class='fa fa-clock-o'></span></button></td><td style='width:10%;'><button class='pure-button button-ignore' onclick='javascript:ignoreTask();' title='I\'m not doing this.'><span class='fa fa-ban'></span></button></td>".format(task[0], task[1]);
            } else {
                document.getElementById("current").innerHTML = "<td style='width:10%;'><button class='pure-button button-complete' onclick='javascript:completeTask();' title='I\'m doing this.'><span class='fa fa-check'></span></button></td><td colspan='2' class='task'><img src='{0}'><p>{1}</p></td><td style='width:10%;'><button class='pure-button button-ignore' onclick='javascript:ignoreTask();' title='I\'m not doing this.'><span class='fa fa-times'></span></button></td>".format(task[0], task[1]);
            }
        }

        function completeTask() {
            if (getTask()[2] !== undefined) {
                // if question -> do question
                Save.current.push(0);
                display(getTask());
            } else {
                // else -> next
                console.log("We are in else! (completeTask())");
                display(getNextTask());
            }
        }

        function skipTask() {
            //TODO add whatever it is to skipped
            display(getNextTask());
        }

        function ignoreTask() {
            display(getNextTask());
        }

        window.onload = function() {
            setTimeout(function() { display(getTask()); }, 1);

            /*
            if (window.addEventListener) {
                window.addEventListener("storage", handleStorage, false);
            } else {
                window.attachEvent("onstorage", handleStorage);
            }
            */
        };
    </script>
</head>
<body>
    <table class="pure-table pure-table-horizontal centered">
        <tbody>
            <tr>
                <th colspan="4">Current Task:</th>
            </tr>
            <tr id="current"></tr>
        </tbody>
        <tfoot>
            <tr>
                <th colspan="4">Skipped Tasks:</th>
            </tr>
            <tr id="skipped">
                <!--TODO these will be generated! NEED FUNCTION NAMES!-/->
                <td><button class="pure-button button-complete" onclick="javascript:nopeTask();" title="Task complete."><span class="fa fa-check-circle-o"></span></button></td>
                <td colspan="2">example</td>
                <td><button class="pure-button button-ignore" onclick="javascript:notTask();" title="I'm not doing this."><span class="fa fa-ban"></span></button></td>-->
            </tr>
        </tfoot>
    </table>
</body>
</html>
