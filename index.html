<html>
<head>
    <link rel="stylesheet" href="css/pure-min-0.6.0.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/style.css">

    <script>
        if (!String.prototype.format) {
            String.prototype.format = function() {
                var args = arguments;
                return this.replace(/{(\d+)}/g, function(match, number) {
                    return typeof args[number] != 'undefined' ? args[number] : match ;
                });
            };
        }

        var Tasks = [
            ["icon.png", "Do this."],
            ["icon.png", "Question?", [
                ["icon.png", "Do a thing."],
                ["icon.png", "Do another thing."],
                ["icon.png", "Another question?", [
                    ["icon.png", "More question! Not really."]
                ]]
            ]],
            ["icon.png", "Final thing!"]
        ];

        var Save = {
            version: 0,
            current: [0],
            skipped: [],
            ignored: []
        };

        function load() {
            var loaded = localStorage.getItem("oschecklist");

            if (loaded != null) {
                Save = JSON.parse(loaded);
                console.log("Task data loaded:");
                console.log(Save);
            } else {
                console.log("Task data not loaded (doesn't exist or invalid).");
            }
        }

        function save() {
            var saveable = JSON.stringify(Save);
            localStorage.setItem("oschecklist", saveable);

            console.log("Saved task data.")
        }

        function getTask() {
            var task = Tasks[Save.current[0]]; //no preceding 2
            if (task === undefined) {
                return ["icon.png", "All tasks complete!"];
            }
            for (var i = 1; i < Save.current.length; i++) {
                task = task[2][Save.current[i]];
            }

            console.log("Got task:");
            console.log(task);

            return task;
        }

        function getNextTask() {
            Save.current[Save.current.length - 1]++;
            var task = Tasks[Save.current[0]]; //no preceding 2
            if (task === undefined) {
                return ["icon.png", "All tasks complete!"];
            }
            for (var i = 1; i < Save.current.length; i++) {
                if (task[2][Save.current[i]] !== undefined) {
                    task = task[2][Save.current[i]];
                } else {
                    Save.current.pop();
                    return getNextTask();
                }
            }

            console.log("Got (next) task:");
            console.log(task);

            return task;
        }

        function display(task) {
            if (task.length == 2) {
                document.getElementById("current").innerHTML = "<td style='width:10%;'><button class='pure-button button-complete' onclick='javascript:completeTask();' title='Task complete.'><span class='fa fa-check'></span></button></td><td class='task'><img src='{0}'><p>{1}</p></td><td style='width:10%;'><button class='pure-button button-later' onclick='javascript:skipTask();' title='Do this later.'><span class='fa fa-clock-o'></span></button></td><td style='width:10%;'><button class='pure-button button-ignore' onclick='javascript:ignoreTask();' title='I\'m not doing this.'><span class='fa fa-times'></span></button></td>".format(task[0], task[1]);
            } else {
                document.getElementById("current").innerHTML = "<td style='width:10%;'><button class='pure-button button-complete' onclick='javascript:completeTask();' title='I\'m doing this.'><span class='fa fa-check'></span></button></td><td colspan='2' class='task'><img src='{0}'><p>{1}</p></td><td style='width:10%;'><button class='pure-button button-ignore' onclick='javascript:ignoreTask();' title='I\'m not doing this.'><span class='fa fa-times'></span></button></td>".format(task[0], task[1]);
            }

            console.log("Displayed task:");
            console.log(task);
        }

        function completeTask() {
            console.log("Completing task:");
            console.log(getTask());

            if (getTask()[2] !== undefined) {
                // if question -> do question
                Save.current.push(0);
                display(getTask());
            } else {
                // else -> next
                display(getNextTask());
            }
        }

        function ignoreTask() {
            console.log("Ignoring task:");
            console.log(getTask());

            // we only save ignored questions
            // (so updates to the question doesn't give us new tasks we don't want)
            if (getTask()[2] !== undefined) {
                Save.ignored.push(Save.current);
            }
            display(getNextTask());
        }

        var nextID = 0; // used in skipTask() and lateTask()

        function skipTask() {
            var id = "id" + nextID++;
            Save.skipped.push([id, Save.current]);
            console.log("Skipping task:");
            var task = getTask();
            console.log(task);
            var skipped = document.createElement("tr");
            skipped.setAttribute("id", "id" + id);
            skipped.innerHTML = "<td style='width:10%;'><button class='pure-button button-complete' onclick='javascript:lateTask({0});' title='Task complete.'><span class='fa fa-check'></span></button></td><td colspan='2' class='task'><img src='{1}'><p>{2}</p></td><td style='width:10%;'><button class='pure-button button-ignore' onclick='javascript:lateTask({0});' title='I\'m not doing this.'><span class='fa fa-times'></span></button></td>".format("id" + id, task[0], task[1]);
            document.getElementById("skipped").appendChild(skipped);
            display(getNextTask());
        }

        function lateTask(id) {
            console.log("Removing late task...");

            // take off of our list
            for (var i = 0; i < Save.skipped.length; i++) {
                if (Save.skipped[i][0] == id) {
                    Save.skipped.splice(i, 1);
                    break;
                }
            }
            // remove element with specified ID
            var element = document.getElementById(id);
            element.parentNode.removeChild(element);

            console.log("Task data:");
            console.log(Save);
        }

        window.onload = function() {
            setTimeout(function() { display(getTask()); }, 1);

            /*
            if (window.addEventListener) {
                window.addEventListener("storage", handleStorage, false);
            } else {
                window.attachEvent("onstorage", handleStorage);
            }
            */
        };
    </script>
</head>
<body>
    <table class="pure-table pure-table-horizontal centered">
        <tbody>
            <tr>
                <th colspan="4">Current Task:</th>
            </tr>

            <tr id="current"></tr>

            <tr>
                <th colspan="4">Skipped Tasks:</th>
            </tr>
        </tbody>

        <tfoot id="skipped"></tfoot>
    </table>
</body>
</html>
